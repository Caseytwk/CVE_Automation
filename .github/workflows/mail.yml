name: CVE Monitor with Teams Alerts

on:
  schedule:
    - cron: '0 1 * * *'   # daily at 1 AM UTC
  workflow_dispatch:

jobs:
  scan-and-alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install requests
      - name: Run CVE scan script
        run: python check_cves.py

      - name: Compare new CVEs with previous results
        id: compare
        run: |
          # Get previous version of the file from last commit
          git show HEAD^:output/results.json > old_results.json || echo '{"results":[]}' > old_results.json
      
          # Use correct path to current results
          NEW_IDS=$(jq -r '.results[].id' output/results.json)
          OLD_IDS=$(jq -r '.results[].id' old_results.json)
      
          NEW_FOUND=false
          for id in $NEW_IDS; do
            if ! echo "$OLD_IDS" | grep -qx "$id"; then
              echo "Found new CVE: $id"
              NEW_FOUND=true
              break
            fi
          done
      
          if [ "$NEW_FOUND" = true ]; then
            echo "new_cve_found=true" >> $GITHUB_OUTPUT
          else
            echo "new_cve_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Microsoft Teams notification
        if: steps.compare.outputs.new_cve_found == 'true'
        run: |
          curl -H "Content-Type: application/json" -d '{
            "text": "ðŸš¨ New CVEs detected in the latest scan! Please check the dashboard: https://caseytwk.github.io/CVE_Automation/"
          }' ${{ secrets.TEAMS_WEBHOOK_URL }}
